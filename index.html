<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bubble Chart</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:          #f8fafc;
      --surface:     #ffffff;
      --border:      #e2e8f0;
      --text:        #0f172a;
      --text-muted:  #64748b;
      --text-subtle: #94a3b8;
      --blue:        #3b82f6;
      --radius:      10px;
      --shadow:      0 1px 3px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.04);
      --shadow-lg:   0 10px 25px rgba(0,0,0,.1), 0 4px 6px rgba(0,0,0,.06);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    #app { max-width: 1140px; margin: 0 auto; padding: 40px 24px 64px; }

    /* ── Header ── */
    .page-title    { font-size: 22px; font-weight: 700; letter-spacing: -.3px; }
    .page-subtitle { font-size: 14px; color: var(--text-muted); margin-top: 4px; }

    /* ── Upload ── */
    #upload-section { margin-top: 32px; }

    #upload-zone {
      background: var(--surface);
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 60px 24px;
      text-align: center;
      cursor: pointer;
      transition: border-color .15s, background .15s;
      user-select: none;
    }
    #upload-zone:hover, #upload-zone.drag-over { border-color: var(--blue); background: #eff6ff; }

    .upload-icon      { color: var(--text-subtle); margin: 0 auto 14px; display: block; }
    .upload-primary   { font-size: 15px; font-weight: 500; }
    .upload-secondary { font-size: 13px; color: var(--text-muted); margin-top: 4px; }
    .upload-hint {
      display: inline-block; margin-top: 14px; padding: 4px 10px;
      font-size: 12px; font-family: ui-monospace, 'Fira Code', monospace;
      color: var(--text-subtle); background: #f1f5f9; border-radius: 4px;
    }

    #upload-error {
      display: none; margin-top: 10px; padding: 10px 14px;
      font-size: 13px; color: #b91c1c;
      background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px;
    }

    /* ── Chart card ── */
    .chart-card {
      display: none;
      margin-top: 24px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 24px;
    }
    #chart-container-1 { margin-top: 32px; }

    .chart-header {
      display: flex; align-items: flex-start;
      justify-content: space-between; margin-bottom: 16px;
    }
    .chart-title    { font-size: 15px; font-weight: 600; }
    .chart-subtitle { font-size: 13px; color: var(--text-muted); margin-top: 3px; }

    .btn-ghost {
      font-size: 13px; color: var(--text-muted); background: none;
      border: 1px solid var(--border); border-radius: 6px;
      padding: 5px 12px; cursor: pointer; white-space: nowrap;
      transition: border-color .15s, color .15s; flex-shrink: 0;
    }
    .btn-ghost:hover { border-color: var(--text-muted); color: var(--text); }

    .chart-svg { display: block; width: 100%; overflow: visible; }

    /* ── Key panel ── */
    .key-inner {
      display: grid;
      grid-template-columns: minmax(140px, 220px) 1px 1fr;
      gap: 0 28px;
      align-items: start;
    }

    .key-divider { background: var(--border); align-self: stretch; }

    .key-heading {
      font-size: 10.5px; font-weight: 700; letter-spacing: .07em;
      text-transform: uppercase; color: var(--text-subtle); margin-bottom: 12px;
    }

    .color-entry {
      display: flex; align-items: center; gap: 8px;
      font-size: 13px; color: var(--text-muted); margin-bottom: 7px;
    }
    .color-swatch {
      width: 11px; height: 11px; border-radius: 50%;
      flex-shrink: 0; opacity: .9;
      border: 1px solid rgba(0,0,0,.08);
    }

    .guide-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px 16px;
    }

    .guide-item-label {
      font-size: 11px; font-weight: 600; letter-spacing: .04em;
      text-transform: uppercase; color: var(--text-muted);
      margin-bottom: 8px;
    }
    .guide-item-desc {
      font-size: 11.5px; color: var(--text-subtle);
      line-height: 1.5; margin-top: 8px;
    }

    @media (max-width: 680px) {
      .key-inner       { grid-template-columns: 1fr; }
      .key-divider     { display: none; }
      .guide-grid      { grid-template-columns: 1fr; }
      .key-section + .key-section { margin-top: 20px; }
    }

    /* ── Tooltip ── */
    #tooltip {
      display: none; position: fixed; z-index: 1000;
      min-width: 200px; max-width: 290px;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); box-shadow: var(--shadow-lg);
      pointer-events: none; overflow: hidden;
    }
    .tt-header {
      padding: 10px 14px 9px; font-size: 13px; font-weight: 600;
      background: #f8fafc; border-bottom: 1px solid var(--border);
    }
    .tt-body { padding: 6px 0; }
    .tt-row  {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 4px; padding: 3px 14px; font-size: 12px;
    }
    .tt-key { color: var(--text-muted); }
    .tt-val { font-weight: 500; text-align: right; word-break: break-word; }

    /* ── D3 helpers ── */
    .axis-label { font-size: 12.5px; fill: #475569; }
  </style>
</head>
<body>
  <div id="app">
    <div>
      <h1 class="page-title">Bubble Chart</h1>
      <p class="page-subtitle">Revenue · AOI · Employees — by company and category</p>
    </div>

    <div id="upload-section">
      <div id="upload-zone" role="button" tabindex="0" aria-label="Upload CSV file">
        <svg class="upload-icon" width="44" height="44" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="16 16 12 12 8 16"></polyline>
          <line x1="12" y1="12" x2="12" y2="21"></line>
          <path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"></path>
        </svg>
        <p class="upload-primary">Upload CSV file</p>
        <p class="upload-secondary">Click to browse or drag &amp; drop</p>
        <code class="upload-hint">Company, Category, Color, Health, Rev (B), AOI (B), Emp (K)</code>
      </div>
      <div id="upload-error" role="alert"></div>
      <input type="file" id="file-input" accept=".csv" style="display:none" aria-hidden="true">
    </div>

    <!-- Chart 1 -->
    <div id="chart-container-1" class="chart-card">
      <div class="chart-header">
        <div>
          <p class="chart-title">Revenue and Adjusted Operating Income (AOI)</p>
          <p class="chart-subtitle">Log scale &nbsp;·&nbsp; Bubble size = Employees (K) &nbsp;·&nbsp; Color = Category</p>
        </div>
        <button class="btn-ghost" id="reload-btn">Upload new file</button>
      </div>
      <svg id="chart-1" class="chart-svg" role="img"></svg>
    </div>

    <!-- Key panel -->
    <div id="chart-key" class="chart-card">
      <div class="key-inner">

        <div class="key-section">
          <p class="key-heading">Categories</p>
          <div id="color-map"></div>
        </div>

        <div class="key-divider"></div>

        <div class="key-section">
          <p class="key-heading">Guide</p>
          <div class="guide-grid">

            <div class="guide-item">
              <p class="guide-item-label">Bubble Size</p>
              <svg viewBox="0 0 190 50" width="190" height="50" aria-hidden="true">
                <circle cx="14" cy="25" r="8"  fill="#94a3b8" fill-opacity=".55" stroke="#94a3b8" stroke-width="1"/>
                <circle cx="46" cy="25" r="15" fill="#94a3b8" fill-opacity=".55" stroke="#94a3b8" stroke-width="1"/>
                <circle cx="92" cy="25" r="22" fill="#94a3b8" fill-opacity=".55" stroke="#94a3b8" stroke-width="1"/>
                <text x="14"  y="45" text-anchor="middle" font-size="9" fill="#94a3b8">Low</text>
                <text x="92"  y="50" text-anchor="middle" font-size="9" fill="#94a3b8">High</text>
                <text x="148" y="29" font-size="11" fill="#64748b" dominant-baseline="middle">Employees</text>
              </svg>
              <p class="guide-item-desc">Bubble area scales with number of employees (K).</p>
            </div>

            <div class="guide-item">
              <p class="guide-item-label">Outline</p>
              <svg viewBox="0 0 190 50" width="190" height="50" aria-hidden="true">
                <circle cx="43" cy="21" r="16" fill="#64748b" fill-opacity=".5" stroke="#0f172a" stroke-width="1.5"/>
                <text x="43"  y="48" text-anchor="middle" font-size="9.5" fill="#64748b">Health co.</text>
                <rect x="90" y="1" width="84" height="40" rx="6" fill="#1e293b"/>
                <circle cx="147" cy="21" r="16" fill="#64748b" fill-opacity=".5" stroke="#ffffff" stroke-width="1.5"/>
                <text x="147" y="48" text-anchor="middle" font-size="9.5" fill="#64748b">Other co.</text>
              </svg>
              <p class="guide-item-desc">Black outline = Health sector company. White outline = All other companies.</p>
            </div>

            <div class="guide-item">
              <p class="guide-item-label">Fill Opacity</p>
              <svg viewBox="0 0 190 50" width="190" height="50" aria-hidden="true">
                <circle cx="43"  cy="21" r="16" fill="#3b82f6" fill-opacity=".65" stroke="#0f172a" stroke-width="1.5"/>
                <text x="43"  y="48" text-anchor="middle" font-size="9.5" fill="#64748b">Health co.</text>
                <circle cx="147" cy="21" r="16" fill="#3b82f6" fill-opacity=".20" stroke="#ffffff" stroke-width="1.5"/>
                <text x="147" y="48" text-anchor="middle" font-size="9.5" fill="#64748b">Other co.</text>
              </svg>
              <p class="guide-item-desc">More opaque = Health sector company. More transparent = All other companies.</p>
            </div>

          </div>
        </div>

      </div>
    </div>

    <!-- Chart 2 -->
    <div id="chart-container-2" class="chart-card">
      <div class="chart-header">
        <div>
          <p class="chart-title">Per Employee Revenue and AOI</p>
          <p class="chart-subtitle">Log scale &nbsp;·&nbsp; Bubble size = Employees (K) &nbsp;·&nbsp; Color = Category</p>
        </div>
      </div>
      <svg id="chart-2" class="chart-svg" role="img"></svg>
    </div>
  </div>

  <div id="tooltip" role="tooltip"></div>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
  'use strict';

  // ── Config ────────────────────────────────────────────────────────────────
  const CONFIG = {
    margin:       { top: 24, right: 32, bottom: 88, left: 82 },
    minRadius:    5,
    maxRadius:    72,
    strokeW:      1,
    transition:   550,
    fallbackColor: '#94a3b8',
  };


  // ── Data Parsing ──────────────────────────────────────────────────────────

  const parseNumber = (val) => {
    if (val == null) return null;
    const raw = String(val).trim();
    if (!raw || /^(n\/?a|null|undefined|[-–—])$/i.test(raw)) return null;
    const isAccounting = raw.startsWith('(') && raw.endsWith(')');
    const cleaned = raw.replace(/[$,\s%()]/g, '');
    const n = parseFloat(cleaned);
    if (isNaN(n)) return null;
    return isAccounting ? -n : n;
  };

  const normalizeKey = (k) => String(k).trim().toLowerCase().replace(/\s+/g, ' ');

  const findCol = (keys, ...candidates) => {
    const index = keys.map(k => [k, normalizeKey(k)]);
    for (const c of candidates) {
      const match = index.find(([, n]) => n === c.toLowerCase());
      if (match) return match[0];
    }
    return null;
  };

  const parseData = (rows) => {
    if (!rows.length) return [];
    const keys = Object.keys(rows[0]);
    const C = {
      company:   findCol(keys, 'company', 'company name', 'name', 'ticker'),
      category:  findCol(keys, 'category', 'sector', 'industry', 'segment', 'type'),
      color:     findCol(keys, 'color', 'colour', 'fill', 'hex', 'color code'),
      health:    findCol(keys, 'health', 'healthy', 'is healthy', 'is_healthy'),
      rev:       findCol(keys, 'rev (b)', 'rev(b)', 'revenue (b)', 'revenue(b)', 'revenue', 'rev'),
      aoi:       findCol(keys, 'aoi (b)', 'aoi(b)', 'aoi'),
      emp:       findCol(keys, 'emp (k)', 'emp(k)', 'employees (k)', 'employees(k)', 'employees', 'emp'),
      revPerEmp: findCol(keys, 'rev/emp (m)', 'rev/emp(m)', 'rev per emp (m)', 'revenue per employee (m)'),
      aoiPerEmp: findCol(keys, 'aoi/emp (m)', 'aoi/emp(m)', 'aoi per emp (m)', 'aoi per employee (m)'),
    };

    return rows
      .map(r => ({
        company:   C.company   ? String(r[C.company]   ?? '').trim() || '—' : '—',
        category:  C.category  ? String(r[C.category]  ?? '').trim() || 'Unknown' : 'Unknown',
        color:     C.color     ? String(r[C.color]     ?? '').trim() || null : null,
        // Default health to true when no Health column (all bubbles styled as healthy)
        health:    C.health    ? /^(yes|y|true|1)$/i.test(String(r[C.health] ?? '').trim()) : true,
        rev:       parseNumber(C.rev       ? r[C.rev]       : null),
        aoi:       parseNumber(C.aoi       ? r[C.aoi]       : null),
        emp:       parseNumber(C.emp       ? r[C.emp]       : null),
        revPerEmp: parseNumber(C.revPerEmp ? r[C.revPerEmp] : null),
        aoiPerEmp: parseNumber(C.aoiPerEmp ? r[C.aoiPerEmp] : null),
        _raw:      r,
      }))
      .filter(d => d.rev != null && d.aoi != null && d.emp != null && d.emp > 0);
  };


  // ── Log Scale Helpers ─────────────────────────────────────────────────────

  /** Returns the minimum positive value in an array, or a fallback. */
  const posMin = (vals, fallback = 1e-3) => {
    const pos = vals.filter(v => v > 0);
    return pos.length ? Math.min(...pos) : fallback;
  };

  /** Clamps a value to a positive floor for log-scale plotting. */
  const clampLog = (v, floor) => (v > 0 ? v : floor);


  // ── Color Accessor ────────────────────────────────────────────────────────

  /** Build a getColor(d) function from the data set. Uses CSV color column if
   *  present, otherwise falls back to a D3 ordinal scale keyed by category. */
  // 20-color palette — handles datasets with many categories
  const PALETTE = [
    ...d3.schemeTableau10,
    '#499894', '#86bcb6', '#d4a6c8', '#f0e442', '#8fbc8f',
    '#cd853f', '#4682b4', '#da70d6', '#3cb371', '#ff7f50',
  ];

  const makeColorAccessor = (data) => {
    const hasColorCol = data.some(d => d.color !== null);
    if (hasColorCol) return d => d.color || CONFIG.fallbackColor;
    const cats    = [...new Set(data.map(d => d.category))].sort();
    const ordinal = d3.scaleOrdinal().domain(cats).range(PALETTE);
    return d => ordinal(d.category);
  };


  // ── Tooltip ───────────────────────────────────────────────────────────────

  const Tooltip = (() => {
    const el = document.getElementById('tooltip');

    const reposition = (event) => {
      const pad = 14, tw = el.offsetWidth, th = el.offsetHeight;
      let x = event.clientX + pad, y = event.clientY + pad;
      if (x + tw > window.innerWidth)  x = event.clientX - tw - pad;
      if (y + th > window.innerHeight) y = event.clientY - th - pad;
      el.style.left = `${x}px`;
      el.style.top  = `${y}px`;
    };

    const show = (event, d) => {
      const rows = Object.entries(d._raw)
        .map(([k, v]) => `<div class="tt-row"><span class="tt-key">${k}</span><span class="tt-val">${v ?? '—'}</span></div>`)
        .join('');
      el.innerHTML = `<div class="tt-header">${d.company}</div><div class="tt-body">${rows}</div>`;
      el.style.display = 'block';
      reposition(event);
    };

    const move = (event) => { if (el.style.display !== 'none') reposition(event); };
    const hide = ()       => { el.style.display = 'none'; };

    return { show, move, hide };
  })();


  // ── Scales ────────────────────────────────────────────────────────────────

  const makeScales = (data, w, h, { xAcc, yAcc, sizeAcc }) => {
    const xVals    = data.map(xAcc);
    const yVals    = data.map(yAcc);
    const xFloor   = posMin(xVals) * 0.1;
    const yFloor   = posMin(yVals) * 0.1;
    const xClamped = xVals.map(v => clampLog(v, xFloor));
    const yClamped = yVals.map(v => clampLog(v, yFloor));
    const xExt     = d3.extent(xClamped);
    const yExt     = d3.extent(yClamped);
    const sizeMax  = d3.max(data, sizeAcc);

    return {
      x:       d3.scaleLog().domain([xExt[0], xExt[1]]).range([0, w]).nice(),
      y:       d3.scaleLog().domain([yExt[0], yExt[1]]).range([h, 0]).nice(),
      size:    d3.scaleSqrt().domain([0, sizeMax]).range([CONFIG.minRadius, CONFIG.maxRadius]),
      xFloor,
      yFloor,
    };
  };


  // ── Grid ──────────────────────────────────────────────────────────────────

  const renderGrid = (g, scales, w, h) => {
    const style = gr =>
      gr.call(a => a.select('.domain').remove())
        .call(a => a.selectAll('.tick line').attr('stroke', '#f1f5f9').attr('stroke-width', 1));

    g.append('g').attr('class', 'grid')
      .call(d3.axisLeft(scales.y).ticks(5).tickSize(-w).tickFormat(''))
      .call(style);

    g.append('g').attr('class', 'grid').attr('transform', `translate(0,${h})`)
      .call(d3.axisBottom(scales.x).ticks(5).tickSize(-h).tickFormat(''))
      .call(style);
  };


  // ── Axes ──────────────────────────────────────────────────────────────────

  const renderAxes = (g, scales, w, h, { xLabel, yLabel, xTickFmt, yTickFmt }) => {
    const styleYAxis = ax =>
      ax.call(a => a.select('.domain').attr('stroke', '#e2e8f0'))
        .call(a => a.selectAll('.tick line').attr('stroke', '#e2e8f0'))
        .call(a => a.selectAll('text').attr('fill', '#64748b').style('font-size', '11.5px'));

    const styleXAxis = ax =>
      ax.call(a => a.select('.domain').attr('stroke', '#e2e8f0'))
        .call(a => a.selectAll('.tick line').attr('stroke', '#e2e8f0'))
        .call(a => a.selectAll('text')
          .attr('fill', '#64748b')
          .style('font-size', '11px')
          .attr('text-anchor', 'end')
          .attr('dx', '-0.5em')
          .attr('dy', '0.4em')
          .attr('transform', 'rotate(-40)'));

    // Use only power-of-10 ticks on x to avoid crowding
    const [xMin, xMax] = scales.x.domain();
    const lo = Math.ceil(Math.log10(xMin));
    const hi = Math.floor(Math.log10(xMax));
    const xTickVals = d3.range(lo, hi + 1).map(e => Math.pow(10, e));

    g.append('g').attr('transform', `translate(0,${h})`)
      .call(d3.axisBottom(scales.x).tickValues(xTickVals).tickFormat(xTickFmt))
      .call(styleXAxis);

    // Same power-of-10 strategy for Y axis
    const [yMin, yMax] = scales.y.domain();
    const ylo = Math.ceil(Math.log10(yMin));
    const yhi = Math.floor(Math.log10(yMax));
    const yTickVals = d3.range(ylo, yhi + 1).map(e => Math.pow(10, e));

    g.append('g')
      .call(d3.axisLeft(scales.y).tickValues(yTickVals).tickFormat(yTickFmt))
      .call(styleYAxis);

    // Zero-equivalent line at the log floor of y

    g.append('line')
      .attr('x1', 0).attr('x2', w)
      .attr('y1', scales.y(yMin)).attr('y2', scales.y(yMin))
      .attr('stroke', '#e2e8f0').attr('stroke-width', 1);

    g.append('text').attr('class', 'axis-label')
      .attr('x', w / 2).attr('y', h + 56)
      .attr('text-anchor', 'middle').text(xLabel);

    g.append('text').attr('class', 'axis-label')
      .attr('transform', 'rotate(-90)')
      .attr('x', -h / 2).attr('y', -64)
      .attr('text-anchor', 'middle').text(yLabel);
  };


  // ── Bubbles ───────────────────────────────────────────────────────────────

  const renderBubbles = (g, data, scales, { xAcc, yAcc, sizeAcc, opacityY, opacityN, getColor }) => {
    const opacity = d => d.health ? opacityY : opacityN;
    const stroke  = d => d.health ? '#000000' : '#ffffff';
    const cx      = d => scales.x(clampLog(xAcc(d), scales.xFloor));
    const cy      = d => scales.y(clampLog(yAcc(d), scales.yFloor));

    const group = g.append('g').attr('class', 'bubbles');

    group.selectAll('circle.bubble')
      .data(data, d => d.company)
      .join('circle')
        .attr('class', 'bubble')
        .attr('cx', cx)
        .attr('cy', cy)
        .attr('r', 0)
        .attr('fill', d => getColor(d))
        .attr('fill-opacity', d => opacity(d))
        .attr('stroke', d => stroke(d))
        .attr('stroke-width', CONFIG.strokeW)
        .style('cursor', 'pointer')
        .on('mouseover', (event, d) => {
          d3.select(event.currentTarget).raise()
            .transition().duration(80)
            .attr('stroke-width', 2.5)
            .attr('fill-opacity', Math.min(opacity(d) + 0.15, 0.95));
          Tooltip.show(event, d);
        })
        .on('mousemove', (event) => Tooltip.move(event))
        .on('mouseout',  (event, d) => {
          d3.select(event.currentTarget)
            .transition().duration(120)
            .attr('stroke-width', CONFIG.strokeW)
            .attr('fill-opacity', opacity(d));
          Tooltip.hide();
        })
      .transition().duration(CONFIG.transition).delay((_, i) => i * 10)
        .attr('r', d => scales.size(sizeAcc(d)));

    // Labels — Health=Yes only, large enough bubbles
    group.selectAll('text.bubble-label')
      .data(data.filter(d => d.health && scales.size(sizeAcc(d)) >= 14), d => d.company)
      .join('text')
        .attr('class', 'bubble-label')
        .attr('x', cx)
        .attr('y', cy)
        .attr('text-anchor', 'middle')
        .attr('dominant-baseline', 'middle')
        .attr('fill', '#ffffff')
        .style('font-size', d => `${Math.min(11, scales.size(sizeAcc(d)) * 0.28)}px`)
        .style('font-weight', '600')
        .style('pointer-events', 'none')
        .style('opacity', 0)
        .text(d => d.company)
      .transition().duration(CONFIG.transition / 2)
        .delay((_, i) => CONFIG.transition * 0.7 + i * 8)
        .style('opacity', 1);
  };


  // ── Key ───────────────────────────────────────────────────────────────────

  const buildColorMap = (data, getColor) => {
    const map = new Map(); // category → first color seen
    for (const d of data) {
      const cat = d.category || 'Unknown';
      if (!map.has(cat)) map.set(cat, getColor(d));
    }
    return [...map.entries()]
      .map(([label, color]) => ({ color, label }))
      .sort((a, b) => a.label.localeCompare(b.label));
  };

  const renderKey = (data, getColor) => {
    const colorMap = buildColorMap(data, getColor);
    document.getElementById('color-map').innerHTML = colorMap
      .map(({ color, label }) => `
        <div class="color-entry">
          <span class="color-swatch" style="background:${color}"></span>
          <span>${label}</span>
        </div>`)
      .join('');
  };


  // ── Chart ─────────────────────────────────────────────────────────────────

  // Fixed logical coordinate space — CSS width:100% scales the SVG responsively.
  // No re-render on resize needed; the viewBox handles it automatically.
  const LOGICAL_W = 960;
  const LOGICAL_H = Math.round(LOGICAL_W * 0.58);

  const renderChart = (data, opts) => {
    const { svgId, xAcc, yAcc, sizeAcc, xLabel, yLabel, xTickFmt, yTickFmt, opacityY, opacityN, getColor } = opts;

    const { margin } = CONFIG;
    const w = LOGICAL_W - margin.left - margin.right;
    const h = LOGICAL_H - margin.top  - margin.bottom;

    const svgEl = document.getElementById(svgId);
    d3.select(svgEl).selectAll('*').remove();
    d3.select(svgEl)
      .attr('width',              '100%')
      .attr('height',             null)
      .attr('viewBox',            `0 0 ${LOGICAL_W} ${LOGICAL_H}`)
      .attr('preserveAspectRatio','xMidYMid meet');

    const g       = d3.select(svgEl).append('g').attr('transform', `translate(${margin.left},${margin.top})`);
    const accessors = { xAcc, yAcc, sizeAcc };
    const scales  = makeScales(data, w, h, accessors);

    // Health companies rendered last so they appear in front of all others
    const sorted = [...data].sort((a, b) => (a.health ? 1 : 0) - (b.health ? 1 : 0));

    renderGrid(g, scales, w, h);
    renderAxes(g, scales, w, h, { xLabel, yLabel, xTickFmt, yTickFmt });
    renderBubbles(g, sorted, scales, { ...accessors, opacityY, opacityN, getColor });
  };


  // ── Chart Definitions ─────────────────────────────────────────────────────

  const fmtB = d => `$${d3.format('.3~g')(d)}B`;
  const fmtM = d => `$${d3.format('.3~g')(d)}M`;

  const CHARTS = [
    {
      svgId:    'chart-1',
      xAcc:     d => d.rev,
      yAcc:     d => d.aoi,
      sizeAcc:  d => d.emp,
      xLabel:   'Revenue (B USD)',
      yLabel:   'AOI (B USD)',
      xTickFmt: fmtB,
      yTickFmt: fmtB,
      opacityY: 0.7,
      opacityN: 0.2,
    },
    {
      svgId:    'chart-2',
      // Use pre-computed CSV columns when available; fall back to division
      xAcc:     d => d.revPerEmp ?? (d.rev / d.emp),
      yAcc:     d => d.aoiPerEmp ?? (d.aoi / d.emp),
      sizeAcc:  d => d.emp,
      xLabel:   'Rev / Emp (M USD)',
      yLabel:   'AOI / Emp (M USD)',
      xTickFmt: fmtM,
      yTickFmt: fmtM,
      opacityY: 0.6,
      opacityN: 0.2,
    },
  ];


  // ── Upload ────────────────────────────────────────────────────────────────

  const Upload = (() => {
    const zone  = document.getElementById('upload-zone');
    const input = document.getElementById('file-input');
    const errEl = document.getElementById('upload-error');

    const showError = msg => { errEl.textContent = msg; errEl.style.display = 'block'; };
    const clearErr  = ()  => { errEl.style.display = 'none'; };
    const showCards = ()  => document.querySelectorAll('.chart-card').forEach(el => el.style.display = 'block');
    const hideCards = ()  => document.querySelectorAll('.chart-card').forEach(el => el.style.display = 'none');

    const process = (file, onData) => {
      clearErr();
      if (!file.name.toLowerCase().endsWith('.csv')) { showError('Please upload a .csv file.'); return; }
      const reader = new FileReader();
      reader.onerror = () => showError('Could not read the file. Please try again.');
      reader.onload  = ({ target }) => {
        const raw  = d3.csvParse(target.result);
        const data = parseData(raw);
        if (!data.length) {
          showError('No plottable rows found. Verify Rev (B), AOI (B), and Emp (K) columns have numeric values.');
          return;
        }
        document.getElementById('upload-section').style.display = 'none';
        showCards();
        requestAnimationFrame(() => onData(data));
      };
      reader.readAsText(file);
    };

    const init = (onData) => {
      zone.addEventListener('click',    () => input.click());
      zone.addEventListener('keydown',  e => { if (e.key === 'Enter' || e.key === ' ') input.click(); });
      zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
      zone.addEventListener('dragleave',() => zone.classList.remove('drag-over'));
      zone.addEventListener('drop', e => {
        e.preventDefault(); zone.classList.remove('drag-over');
        const file = e.dataTransfer.files[0];
        if (file) process(file, onData);
      });
      input.addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) process(file, onData);
        input.value = '';
      });
      document.getElementById('reload-btn').addEventListener('click', () => {
        document.getElementById('upload-section').style.display = 'block';
        hideCards(); _renders = []; clearErr();
      });
    };

    return { init };
  })();


  // ── Init ──────────────────────────────────────────────────────────────────
  Upload.init((data) => {
    const getColor = makeColorAccessor(data);
    renderKey(data, getColor);
    CHARTS.forEach(opts => renderChart(data, { ...opts, getColor }));
  });
  </script>
</body>
</html>
